!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("onnxruntime-web")):"function"==typeof define&&define.amd?define(["exports","onnxruntime-web"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).RembgWeb={},e.ort)}(this,function(e,n){"use strict";function t(e){var n=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})}}),n.default=e,Object.freeze(n)}var o=t(n);function r(e,n,t,o){var r,s=arguments.length,i=s<3?n:null===o?o=Object.getOwnPropertyDescriptor(n,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,n,t,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(n,t,i):r(n,t))||i);return s>3&&i&&Object.defineProperty(n,t,i),i}"function"==typeof SuppressedError&&SuppressedError;class s{static instance;customModelPaths=new Map;baseUrl="/models";webnnEnabled=!1;webnnDeviceType="gpu";webnnPowerPreference="default";webgpuEnabled=!1;webgpuPowerPreference="default";generalLoggingEnabled=!1;performanceLoggingEnabled=!1;onnxProfilingEnabled=!1;sessionCacheBypass=!1;modelCacheBypass=!1;constructor(){this.initializeDefaultPaths()}static getInstance(){return s.instance||(s.instance=new s),s.instance}initializeDefaultPaths(){this.customModelPaths.clear()}setCustomModelPath(e,n){this.customModelPaths.set(e,n),this.generalLoggingEnabled}getCustomModelPath(e){return this.customModelPaths.get(e)}getAllModelPaths(){return new Map(this.customModelPaths)}hasCustomPath(e){const n=this.customModelPaths.get(e);return void 0!==n&&""!==n}resetToDefaults(){this.baseUrl="/models",this.customModelPaths.clear(),this.initializeDefaultPaths(),this.generalLoggingEnabled}removeCustomPath(e){this.customModelPaths.has(e)&&(this.customModelPaths.delete(e),this.generalLoggingEnabled)}getAvailableModels(){return["u2net","u2netp","u2net_human_seg","u2net_cloth_seg","isnet-general-use","isnet-anime","silueta","u2net_custom"]}setBaseUrl(e){this.baseUrl=e,this.generalLoggingEnabled,this.initializeDefaultPaths()}getBaseUrl(){return this.baseUrl}enableWebNN(e){this.webnnEnabled=e,this.generalLoggingEnabled}setWebNNDeviceType(e){this.webnnDeviceType=e,this.generalLoggingEnabled}setWebNNPowerPreference(e){this.webnnPowerPreference=e,this.generalLoggingEnabled}isWebNNEnabled(){return this.webnnEnabled}getWebNNDeviceType(){return this.webnnDeviceType}getWebNNPowerPreference(){return this.webnnPowerPreference}getWebNNConfig(){return{enabled:this.webnnEnabled,deviceType:this.webnnDeviceType,powerPreference:this.webnnPowerPreference}}resetWebNNSettings(){this.webnnEnabled=!1,this.webnnDeviceType="gpu",this.webnnPowerPreference="default",this.generalLoggingEnabled}enableWebGPU(e){this.webgpuEnabled=e,this.generalLoggingEnabled}setWebGPUPowerPreference(e){this.webgpuPowerPreference=e,this.generalLoggingEnabled}isWebGPUEnabled(){return this.webgpuEnabled}getWebGPUPowerPreference(){return this.webgpuPowerPreference}getWebGPUConfig(){return{enabled:this.webgpuEnabled,powerPreference:this.webgpuPowerPreference}}resetWebGPUSettings(){this.webgpuEnabled=!1,this.webgpuPowerPreference="default",this.generalLoggingEnabled}enableGeneralLogging(e){this.generalLoggingEnabled=e,this.generalLoggingEnabled}enablePerformanceLogging(e){this.performanceLoggingEnabled=e,this.performanceLoggingEnabled}isGeneralLoggingEnabled(){return this.generalLoggingEnabled}isPerformanceLoggingEnabled(){return this.performanceLoggingEnabled}enableONNXProfiling(e){this.onnxProfilingEnabled=e,this.onnxProfilingEnabled}isONNXProfilingEnabled(){return this.onnxProfilingEnabled}getLoggingConfig(){return{generalLogging:this.generalLoggingEnabled,performanceLogging:this.performanceLoggingEnabled,onnxProfiling:this.onnxProfilingEnabled}}resetLoggingSettings(){this.generalLoggingEnabled=!1,this.performanceLoggingEnabled=!1,this.onnxProfilingEnabled=!1,this.generalLoggingEnabled}setSessionCacheBypass(e){this.sessionCacheBypass=e,this.generalLoggingEnabled}setModelCacheBypass(e){this.modelCacheBypass=e,this.generalLoggingEnabled}isSessionCacheBypassEnabled(){return this.sessionCacheBypass}isModelCacheBypassEnabled(){return this.modelCacheBypass}getCacheBypassConfig(){return{sessionCacheBypass:this.sessionCacheBypass,modelCacheBypass:this.modelCacheBypass}}resetCacheBypassSettings(){this.sessionCacheBypass=!1,this.modelCacheBypass=!1,this.generalLoggingEnabled}}const i=s.getInstance();function a(...e){i.isGeneralLoggingEnabled()}function c(...e){i.isGeneralLoggingEnabled()}function l(...e){i.isPerformanceLoggingEnabled()}function g(...e){}function d(e){return function(e,n,t){const o=t.value;return t.value=async function(...e){const n=performance.now();l();try{const t=await o.apply(this,e),r=performance.now();return l((r-n).toFixed(2)),t}catch(e){throw(performance.now()-n).toFixed(2),e}},t}}function u(e){return function(e,n,t){const o=t.value;return t.value=function(...e){const n=performance.now();l();try{const t=o.apply(this,e),r=performance.now();return l((r-n).toFixed(2)),t}catch(e){throw(performance.now()-n).toFixed(2),e}},t}}function m(e){const n=document.createElement("canvas"),t=n.getContext("2d");if(!t)throw new Error("Failed to get context for canvas");return t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",e instanceof HTMLImageElement?(n.width=e.naturalWidth,n.height=e.naturalHeight,t.drawImage(e,0,0)):(n.width=e.width,n.height=e.height,t.putImageData(e,0,0)),n}function p(e){const n=performance.now();return a((e instanceof File&&e.name,(e.size/1024).toFixed(1))),new Promise((t,o)=>{const r=new Image,s=URL.createObjectURL(e);r.onload=()=>{l(((performance.now()-n).toFixed(2),r.naturalWidth,r.naturalHeight)),URL.revokeObjectURL(s),t(r)},r.onerror=e=>{(performance.now()-n).toFixed(2),URL.revokeObjectURL(s),o(e)},r.src=s})}function f(e){const n=performance.now();return a((e.byteLength/1024).toFixed(1)),new Promise((t,o)=>{const r=new Blob([e]),s=new Image,i=URL.createObjectURL(r);s.onload=()=>{l(((performance.now()-n).toFixed(2),s.naturalWidth,s.naturalHeight)),URL.revokeObjectURL(i),t(s)},s.onerror=e=>{(performance.now()-n).toFixed(2),URL.revokeObjectURL(i),o(e)},s.src=i})}function h(e,n="image/png"){const t=performance.now();return a((e.width,e.height)),new Promise((o,r)=>{e.toBlob(e=>{const n=performance.now()-t;e?(l((n.toFixed(2),(e.size/1024).toFixed(1))),o(e)):(n.toFixed(2),r(new Error("Failed to convert canvas to blob")))},n)})}function w(e,n,t="input.1"){const r=performance.now(),s=document.createElement("canvas");s.width=n.size[0],s.height=n.size[1];const i=s.getContext("2d");if(!i)throw new Error("Failed to get context for temp canvas");i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(e,0,0,n.size[0],n.size[1]);const a=performance.now(),c=i.getImageData(0,0,n.size[0],n.size[1]).data,g=n.size[0],d=n.size[1];let u=0;for(let e=0;e<c.length;e+=4){const n=c[e]/255,t=c[e+1]/255,o=c[e+2]/255;u=Math.max(u,n,t,o)}const m=Math.max(u,1e-6),p=performance.now(),f=new Float32Array(3*d*g);for(let e=0;e<d;e++)for(let t=0;t<g;t++){const o=4*(e*g+t),r=c[o]/255,s=c[o+1]/255/m,i=c[o+2]/255/m,a=(r/m-n.mean[0])/n.std[0],l=(s-n.mean[1])/n.std[1],u=(i-n.mean[2])/n.std[2];f[e*g+t]=a,f[d*g+e*g+t]=l,f[2*d*g+e*g+t]=u}const h=performance.now(),w=new o.Tensor("float32",f,[1,3,d,g]),b=performance.now();return l(((a-r).toFixed(2),(p-a).toFixed(2),(h-p).toFixed(2),(b-h).toFixed(2),(b-r).toFixed(2),u.toFixed(6),m.toFixed(6))),{[t]:w}}function b(e,n=[1,1,320,320]){const[,,t,o]=n,r=performance.now(),s=e.slice(0,t*o);e.length!==t*o&&e.length;l((performance.now()-r).toFixed(2));const i=performance.now();let a=s[0],c=s[0];for(let e=1;e<s.length;e++)s[e]<a&&(a=s[e]),s[e]>c&&(c=s[e]);l(((performance.now()-i).toFixed(2),a.toFixed(6),c.toFixed(6)));const g=performance.now(),d=new Float32Array(s.length);for(let e=0;e<s.length;e++)d[e]=(s[e]-a)/(c-a);return l((performance.now()-g).toFixed(2)),d}function P(e,{width:n,height:t}){const o=performance.now(),r=document.createElement("canvas");r.width=n,r.height=t;const s=r.getContext("2d");if(!s)throw new Error("Failed to get context for mask canvas");s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";const i=s.createImageData(n,t);for(let n=0;n<e.length;n++){const t=Math.round(255*e[n]),o=4*n;i.data[o]=t,i.data[o+1]=t,i.data[o+2]=t,i.data[o+3]=255}s.putImageData(i,0,0);return l((performance.now()-o).toFixed(2)),r}function y(e,n){const t=performance.now(),{width:o,height:r}=e,s=document.createElement("canvas");s.width=n.width,s.height=n.height;const i=s.getContext("2d");if(!i)throw new Error("Failed to get context for resized canvas");i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(e,0,0,n.width,n.height);return l(((performance.now()-t).toFixed(2),n.width,n.height)),s}function x(e,n,t=[1,1,320,320]){const o=performance.now();a((e.length,n.width,n.height));const r=b(e,t),[,,s,i]=t,c=y(P(r,{width:i,height:s}),n);return l((performance.now()-o).toFixed(2)),c}function v(e,n){const t=performance.now();a((e.width,e.height));const o=document.createElement("canvas");o.width=e.width,o.height=e.height;const r=o.getContext("2d");if(!r)throw new Error("Failed to get context for result canvas");const s=performance.now();r.drawImage(e,0,0);l((performance.now()-s).toFixed(2));const i=performance.now(),c=r.getImageData(0,0,o.width,o.height),g=n.getContext("2d");if(!g)throw new Error("Failed to get context for mask canvas");const d=g.getImageData(0,0,n.width,n.height);l((performance.now()-i).toFixed(2));const u=performance.now();for(let e=0;e<c.data.length;e+=4){const n=e,t=d.data[n];c.data[e+3]=t}l((performance.now()-u).toFixed(2));const m=performance.now();r.putImageData(c,0,0);l((performance.now()-m).toFixed(2));return l((performance.now()-t).toFixed(2)),o}function N(e,n){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const o=t.getContext("2d");if(!o)throw new Error("Failed to get context for result canvas");return o.fillStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${n[3]/255})`,o.fillRect(0,0,t.width,t.height),o.drawImage(e,0,0),t}function E(e){const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const t=n.getContext("2d");if(!t)throw new Error("Failed to get context for result canvas");return t.filter="blur(2px)",t.drawImage(e,0,0),t.filter="none",n}function F(e){const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const t=n.getContext("2d");if(!t)throw new Error("Failed to get context for result canvas");t.drawImage(e,0,0);const o=t.getImageData(0,0,n.width,n.height),r=o.data;for(let e=0;e<r.length;e+=4){const n=r[e];r[e]=n,r[e+1]=n,r[e+2]=n,r[e+3]=255}return t.putImageData(o,0,0),n}var M=Object.freeze({__proto__:null,applyBackgroundColor:N,arrayBufferToImage:f,canvasToBlob:h,canvasToImageData:function(e){const n=e.getContext("2d");if(!n)throw new Error("Failed to get context for canvas");return n.getImageData(0,0,e.width,e.height)},createGrayScaleMask:P,createMaskOnly:F,fileToImage:p,imageDataToCanvas:function(e){const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const t=n.getContext("2d");if(!t)throw new Error("Failed to get context for canvas");return t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.putImageData(e,0,0),n},imageToCanvas:m,mergeMasks:function(e){if(!e||0===e.length)throw new Error("mergeMasks: no masks provided");const n=e[0].length;for(let t=1;t<e.length;t++)if(e[t].length!==n)throw new Error(`mergeMasks: mask at index ${t} has different size (expected ${n}, got ${e[t].length})`);if(1===e.length)return e[0].slice();const t=new Float32Array(n);t.set(e[0]);for(let o=1;o<e.length;o++){const r=e[o];for(let e=0;e<n;e++){const n=r[e];n>t[e]&&(t[e]=n)}}return t},naiveCutout:v,normalizeImage:w,normalizeMask:b,postProcessMask:E,processModelOutput:x,resizeMask:y});const C={"u2net.onnx":"a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456","u2netp.onnx":"b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef1234567","u2net_human_seg.onnx":"c3d4e5f6789012345678901234567890abcdef1234567890abcdef12345678","u2net_cloth_seg.onnx":"d4e5f6789012345678901234567890abcdef1234567890abcdef123456789","silueta.onnx":"75da6c8d2f8096ec743d071951be73b4a8bc7b3e51d9a6625d63644f90ffeedb"};async function S(e,n){try{const t=C[e];if(!t)return!0;const o=await async function(e){const n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}(n)===t;return o}catch(e){return!1}}function U(e,n){const t=n.byteLength/1048576,o={"u2net.onnx":{min:170,max:180},"u2netp.onnx":{min:4,max:5},"u2net_human_seg.onnx":{min:170,max:180},"u2net_cloth_seg.onnx":{min:170,max:180},"silueta.onnx":{min:40,max:50}}[e];if(!o)return!0;const r=t>=o.min&&t<=o.max;return r}async function I(e,n){if(!U(e,n))return!1;return!!await S(e,n)}function L(){try{return"undefined"!=typeof navigator&&"gpu"in navigator&&"object"==typeof navigator.gpu&&null!==navigator.gpu}catch(e){return c(),!1}}function D(e){return!(e?.webgpuPowerPreference&&!["default","low-power","high-performance"].includes(e.webgpuPowerPreference))||(e.webgpuPowerPreference,!1)}async function T(){const e=performance.now();a();const n=performance.now(),t=L();l((performance.now()-n).toFixed(2));let o=null;if(t)try{const e=performance.now(),n=await(navigator.gpu?.requestAdapter());if(l((performance.now()-e).toFixed(2)),n&&"requestAdapterInfo"in n){const e=performance.now();o=await n.requestAdapterInfo();l((performance.now()-e).toFixed(2))}}catch(e){c()}return l((performance.now()-e).toFixed(2)),{available:t,adapterInfo:o,userAgent:"undefined"!=typeof navigator?navigator.userAgent:"unknown"}}function z(){try{return"undefined"!=typeof navigator&&"ml"in navigator&&"object"==typeof navigator.ml&&null!==navigator.ml}catch(e){return c(),!1}}function k(e={}){const n=performance.now();a();const t=[];if(a((e.executionProviders,e.preferWebNN,e.webnnDeviceType,e.webnnPowerPreference,e.preferWebGPU,e.webgpuPowerPreference)),e.executionProviders&&e.executionProviders.length>0){return l((performance.now()-n).toFixed(2)),a(e.executionProviders.join(", ")),[...e.executionProviders]}const o=performance.now(),r=e.preferWebNN??!1,s=z();l((performance.now()-o).toFixed(2)),a(),r&&s&&(t.push("webnn"),a());const i=performance.now(),c=e.preferWebGPU??!1,g=L();l((performance.now()-i).toFixed(2)),a(),c&&g&&(t.push("webgpu"),a()),t.push("webgl","cpu");return l(((performance.now()-n).toFixed(2),t.join(", "))),t}function W(e){return e?.webnnDeviceType&&!["cpu","gpu","npu"].includes(e.webnnDeviceType)?(e.webnnDeviceType,!1):e?.webnnPowerPreference&&!["default","low-power","high-performance"].includes(e.webnnPowerPreference)?(e.webnnPowerPreference,!1):!(e?.webgpuPowerPreference&&!["default","low-power","high-performance"].includes(e.webgpuPowerPreference))||(e.webgpuPowerPreference,!1)}async function O(e){const n=performance.now();if(a(),!z()){return l((performance.now()-n).toFixed(2)),!1}try{const t=performance.now(),o=await(navigator.ml?.createContext({deviceType:e}));l((performance.now()-t).toFixed(2));const r=null!==o;return l((performance.now()-n).toFixed(2)),r}catch(e){return c((performance.now()-n).toFixed(2)),!1}}async function B(){const e=performance.now();a();const n=performance.now(),t=z();l((performance.now()-n).toFixed(2));const o=[];if(t){const e=["cpu","gpu","npu"],n=performance.now();for(const n of e){const e=performance.now();await O(n)&&o.push(n);l((performance.now()-e).toFixed(2))}l((performance.now()-n).toFixed(2))}return l(((performance.now()-e).toFixed(2),o.join(", "))),{available:t,supportedDevices:o,userAgent:"undefined"!=typeof navigator?navigator.userAgent:"unknown"}}const _={simd:!0,proxy:!1,numThreads:4};function A(e=_){o.env.wasm.simd=e.simd??_.simd,o.env.wasm.proxy=e.proxy??_.proxy,o.env.wasm.numThreads=e.numThreads??_.numThreads}A();class ${modelName;session=null;modelData=null;options;constructor(e,n={}){this.modelName=e,this.options={..._,...n},this.options.simd=this.options.simd??_.simd,this.options.proxy=this.options.proxy??_.proxy,this.options.numThreads=this.options.numThreads??_.numThreads,A(this.options)}emitProgress(e,n,t){this.options.onProgress&&this.options.onProgress({step:e,progress:n,message:t})}async initialize(){if(a(this.modelName),this.emitProgress("initializing",0,"Starting session initialization..."),this.session)return a(this.modelName),void this.emitProgress("initializing",100,"Session already initialized, skipping");this.emitProgress("initializing",20,"Validating configuration..."),await this.validateConfiguration(),this.emitProgress("initializing",50,"Downloading model..."),this.modelData=await this.downloadModel(),this.emitProgress("initializing",60,"Setting up execution providers...");const e=await this.setupExecutionProviders();this.emitProgress("initializing",80,"Creating session..."),await this.createSession(e),this.emitProgress("initializing",100,"Session initialized successfully")}async validateConfiguration(){W(this.options),D(this.options)}async setupExecutionProviders(){const e=k(this.options);if(this.options.preferWebNN){const n=z();a(),n&&a(e.join(", "))}if(this.options.preferWebGPU){const n=L();a(),n&&a(e.join(", "))}return e}async createSession(e){let n=!1,t=null;if(!this.modelData)throw new Error("Model data not found");for(const r of e)try{a(this.modelName),this.session=await o.InferenceSession.create(this.modelData,{executionProviders:[r],enableProfiling:i.isONNXProfilingEnabled()}),l(this.modelName),i.isONNXProfilingEnabled()&&a(this.modelName),n=!0;break}catch(e){g(this.modelName),t=e;continue}if(!n)throw new Error(`Failed to create ONNX session with any provider. Last error: ${t?.message||"Unknown error"}`)}async downloadModel(){if(a(this.modelName),this.options.bypassModelCache)a(this.modelName);else try{this.emitProgress("downloading",10,"Checking cache...");const e=await this.getCachedModel();if(e)return a((this.modelName,this.modelName)),this.emitProgress("downloading",100,"Using cached model"),e}catch(e){this.modelName}a((this.modelName,this.modelName));const e=this.getModelUrl();this.emitProgress("downloading",20,"Starting download...");try{const n=await fetch(e);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const t=n.headers.get("content-length"),o=t?parseInt(t,10):0;if(a((this.modelName,(o/1048576).toFixed(2))),o>0){this.emitProgress("downloading",30,"Downloading model...");const e=n.body?.getReader();if(e){const n=[];let t=0,r=!1;for(;!r;){const s=await e.read();if(r=s.done,r||!s.value)break;const i=s.value;n.push(i),t+=i.length;const a=30+Math.round(t/o*60);this.emitProgress("downloading",a,`Downloading model... ${Math.round(t/o*100)}%`)}const s=new Uint8Array(t);let i=0;for(const e of n)s.set(e,i),i+=e.length;this.emitProgress("downloading",90,"Download complete"),this.emitProgress("downloading",95,"Validating model...");if(!await I(this.modelName,s.buffer))throw new Error(`Model integrity validation failed for ${this.modelName}`);try{await this.cacheModel(s.buffer)}catch(e){this.modelName}return this.emitProgress("downloading",100,"Model ready"),s.buffer}}this.emitProgress("downloading",50,"Downloading model...");const r=await n.arrayBuffer();this.emitProgress("downloading",90,"Download complete"),this.emitProgress("downloading",95,"Validating model...");if(!await I(this.modelName,r))throw new Error(`Model integrity validation failed for ${this.modelName}`);try{await this.cacheModel(r)}catch(e){this.modelName}return this.emitProgress("downloading",100,"Model ready"),r}catch(e){throw this.modelName,new Error(`Failed to download model ${this.modelName}: ${e}`)}}async getCachedModel(){return new Promise((e,n)=>{const t=indexedDB.open("rembg-models",2);t.onerror=()=>n(t.error),t.onsuccess=()=>{const o=t.result.transaction(["models"],"readonly").objectStore("models").get(this.modelName);o.onsuccess=()=>{const n=o.result;if(!n)return void e(null);const t=this.getModelVersion(),r=n.version||"1.0.0";if(r!==t)return c(this.modelName),void e(null);e(n.data||null)},o.onerror=()=>n(o.error)},t.onupgradeneeded=()=>{const e=t.result;if(!e.objectStoreNames.contains("models")){e.createObjectStore("models",{keyPath:"name"}).createIndex("version","version",{unique:!1})}}})}async cacheModel(e){return new Promise((n,t)=>{const o=indexedDB.open("rembg-models",2);o.onerror=()=>t(o.error),o.onsuccess=()=>{const r=o.result.transaction(["models"],"readwrite").objectStore("models").put({name:this.modelName,data:e,timestamp:Date.now(),version:this.getModelVersion()});r.onsuccess=()=>n(),r.onerror=()=>t(r.error)},o.onupgradeneeded=()=>{const e=o.result;if(!e.objectStoreNames.contains("models")){e.createObjectStore("models",{keyPath:"name"}).createIndex("version","version",{unique:!1})}}})}getModelUrl(){const e=i.getCustomModelPath(this.modelName);return e&&""!==e?(a(this.modelName),e):this.getDefaultModelUrl()}getModelVersion(){return"1.0.0"}prepareInput(e){return w(e,this.getNormalizationParams(),this.getInputName())}async runInference(e){if(!this.session)throw new Error("Session not initialized");const n=await this.session.run(e);if(i.isONNXProfilingEnabled())try{this.session.endProfiling(),a(this.modelName)}catch(e){this.modelName}return n}async predict(e){if(a((this.modelName,e.width,e.height)),this.session||await this.initialize(),!this.session)throw new Error("Session not initialized");const n=this.prepareInput(e),t=await this.runInference(n),o=this.outputToMaskArray(t);return a((this.modelName,o.length)),o.map(n=>this.maskArrayToMaskCanvas(n,{width:e.width,height:e.height}))}outputToMaskArray(e){return[e[Object.keys(e)[0]].data]}maskArrayToMaskCanvas(e,n){return x(e,n,this.getOutputShape())}static getName(){throw new Error("getName() must be implemented by subclass")}getName(){return this.modelName}getOptions(){return{...this.options}}async dispose(){this.session&&(await this.session.release(),this.session=null),this.modelData=null}static async clearCache(){return new Promise((e,n)=>{try{const t=indexedDB.deleteDatabase("rembg-models");t.onsuccess=()=>{a(),e()},t.onerror=()=>{t.error,n(t.error)}}catch(e){n(e)}})}static async clearModelCache(e){return new Promise((n,t)=>{try{const o=indexedDB.open("rembg-models",2);o.onerror=()=>t(o.error),o.onsuccess=()=>{const r=o.result.transaction(["models"],"readwrite").objectStore("models").delete(e);r.onsuccess=()=>{a(),n()},r.onerror=()=>t(r.error)},o.onupgradeneeded=()=>{const e=o.result;if(!e.objectStoreNames.contains("models")){e.createObjectStore("models",{keyPath:"name"}).createIndex("version","version",{unique:!1})}}}catch(e){t(e)}})}}r([d()],$.prototype,"initialize",null),r([d()],$.prototype,"validateConfiguration",null),r([d()],$.prototype,"setupExecutionProviders",null),r([d()],$.prototype,"createSession",null),r([d()],$.prototype,"downloadModel",null),r([d()],$.prototype,"getCachedModel",null),r([d()],$.prototype,"cacheModel",null),r([u()],$.prototype,"prepareInput",null),r([d()],$.prototype,"runInference",null),r([d()],$.prototype,"predict",null),r([u()],$.prototype,"outputToMaskArray",null),r([u()],$.prototype,"maskArrayToMaskCanvas",null);class j extends ${constructor(e){super("u2net",e)}getDefaultModelUrl(){return`${i.getBaseUrl()}/u2net.onnx`}getNormalizationParams(){return{mean:[.485,.456,.406],std:[.229,.224,.225],size:[320,320]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,1,320,320]}static getName(){return"u2net"}}class G extends ${constructor(e){super("u2netp",e)}getDefaultModelUrl(){return`${i.getBaseUrl()}/u2netp.onnx`}getNormalizationParams(){return{mean:[.485,.456,.406],std:[.229,.224,.225],size:[320,320]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,1,320,320]}static getName(){return"u2netp"}}class R extends ${constructor(e){super("u2net_human_seg",e)}getDefaultModelUrl(){return`${i.getBaseUrl()}/u2net_human_seg.onnx`}getNormalizationParams(){return{mean:[.485,.456,.406],std:[.229,.224,.225],size:[320,320]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,1,320,320]}static getName(){return"u2net_human_seg"}}class H extends ${clothCategory="combined";constructor(e){super("u2net_cloth_seg",e)}setClothCategory(e){this.clothCategory=e}getClothCategory(){return this.clothCategory}getDefaultModelUrl(){return`${i.getBaseUrl()}/u2net_cloth_seg.onnx`}getNormalizationParams(){return{mean:[.485,.456,.406],std:[.229,.224,.225],size:[768,768]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,3,768,768]}outputToMaskArray(e){const n=e[Object.keys(e)[0]],t=n.data,[,o,r,s]=n.dims,i=this.logSoftmax(t,o,r*s),a=this.argmax(i,o,r*s),c=[];for(let e=1;e<=3;e++){const n=new Float32Array(r*s);for(let t=0;t<a.length;t++)n[t]=a[t]===e?255.5:0;c.push(n)}return c}maskArrayToMaskCanvas(e,n){return x(e,n,this.getOutputShape())}logSoftmax(e,n,t){const o=new Float32Array(e.length);for(let r=0;r<t;r++){let s=e[r];for(let o=1;o<n;o++)s=Math.max(s,e[o*t+r]);let i=0;for(let o=0;o<n;o++)i+=Math.exp(e[o*t+r]-s);const a=Math.log(i)+s;for(let s=0;s<n;s++)o[s*t+r]=e[s*t+r]-a}return o}argmax(e,n,t){const o=new Uint8Array(t);for(let r=0;r<t;r++){let s=e[r],i=0;for(let o=1;o<n;o++){const n=e[o*t+r];n>s&&(s=n,i=o)}o[r]=i}return o}static getName(){return"u2net_cloth_seg"}}class q extends ${config;constructor(e,n){if(super("u2net_custom",n),this.config=e,!e.modelPath)throw new Error("u2net_custom requires modelPath in config")}getModelUrl(){const e=i.getCustomModelPath(this.modelName);return e&&""!==e?(c(this.modelName),e):this.config.modelPath}getDefaultModelUrl(){return this.config.modelPath}getNormalizationParams(){return{mean:this.config.mean||[.485,.456,.406],std:this.config.std||[.229,.224,.225],size:this.config.inputSize||[320,320]}}getInputName(){return this.config.inputName?this.config.inputName:this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){const e=this.config.inputSize||[320,320];return[1,1,e[0],e[1]]}static getName(){return"u2net_custom"}getConfig(){return{...this.config}}}class X extends ${constructor(e){super("isnet-general-use",e)}getDefaultModelUrl(){return`${i.getBaseUrl()}/isnet-general-use.onnx`}getNormalizationParams(){return{mean:[.5,.5,.5],std:[1,1,1],size:[1024,1024]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,1,1024,1024]}static getName(){return"isnet-general-use"}}class V extends ${constructor(e){super("isnet-anime",e)}getDefaultModelUrl(){return`${i.getBaseUrl()}/isnet-anime.onnx`}getNormalizationParams(){return{mean:[.485,.456,.406],std:[1,1,1],size:[1024,1024]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,1,1024,1024]}static getName(){return"isnet-anime"}}class Q extends ${constructor(e){super("silueta",e)}getDefaultModelUrl(){return`${i.getBaseUrl()}/silueta.onnx`}getNormalizationParams(){return{mean:[.485,.456,.406],std:[.229,.224,.225],size:[320,320]}}getInputName(){return this.session?this.session.inputNames[0]:"input_image"}getOutputShape(){return[1,1,320,320]}static getName(){return"silueta"}}const J=new Map;J.set("u2net",j),J.set("u2netp",G),J.set("u2net_human_seg",R),J.set("u2net_cloth_seg",H),J.set("isnet-general-use",X),J.set("isnet-anime",V),J.set("silueta",Q);const K={U2NetSession:j,U2NetpSession:G,U2NetHumanSegSession:R,U2NetClothSegSession:H,IsNetGeneralUseSession:X,IsNetAnimeSession:V,SiluetaSession:Q},Y=new Map,Z=[],ee={maxSessions:5,maxMemoryMB:500},ne={hits:0,misses:0,evictions:0,totalSessions:0};function te(e,n){const t=[];e.preferWebNN!==n.preferWebNN&&t.push(`preferWebNN: ${e.preferWebNN} vs ${n.preferWebNN}`),e.webnnDeviceType!==n.webnnDeviceType&&t.push(`webnnDeviceType: ${e.webnnDeviceType} vs ${n.webnnDeviceType}`),e.webnnPowerPreference!==n.webnnPowerPreference&&t.push(`webnnPowerPreference: ${e.webnnPowerPreference} vs ${n.webnnPowerPreference}`),e.preferWebGPU!==n.preferWebGPU&&t.push(`preferWebGPU: ${e.preferWebGPU} vs ${n.preferWebGPU}`),e.webgpuPowerPreference!==n.webgpuPowerPreference&&t.push(`webgpuPowerPreference: ${e.webgpuPowerPreference} vs ${n.webgpuPowerPreference}`),e.simd!==n.simd&&t.push(`simd: ${e.simd} vs ${n.simd}`),e.proxy!==n.proxy&&t.push(`proxy: ${e.proxy} vs ${n.proxy}`),e.numThreads!==n.numThreads&&t.push(`numThreads: ${e.numThreads} vs ${n.numThreads}`);const o=JSON.stringify(e.executionProviders?.sort()),r=JSON.stringify(n.executionProviders?.sort());return o!==r&&t.push(`executionProviders: ${o} vs ${r}`),!(t.length>0)||(a(t.join(", ")),!1)}function oe(e){const n=Z.indexOf(e);n>-1&&Z.splice(n,1),Z.push(e)}async function re(){if(0===Z.length)return;const e=Z[0],n=Y.get(e);n&&(await n.dispose(),Y.delete(e),Z.shift(),ne.evictions++)}async function se(){for(;Y.size>=ee.maxSessions;)await re()}async function ie(e="u2net",n,t){const o=performance.now();a();const r=performance.now(),s={...t,preferWebNN:t?.preferWebNN??i.isWebNNEnabled(),webnnDeviceType:t?.webnnDeviceType??i.getWebNNDeviceType(),webnnPowerPreference:t?.webnnPowerPreference??i.getWebNNPowerPreference(),preferWebGPU:t?.preferWebGPU??i.isWebGPUEnabled(),webgpuPowerPreference:t?.webgpuPowerPreference??i.getWebGPUPowerPreference(),bypassSessionCache:t?.bypassSessionCache??i.isSessionCacheBypassEnabled(),bypassModelCache:t?.bypassModelCache??i.isModelCacheBypassEnabled()};if(l((performance.now()-r).toFixed(2)),"u2net_custom"===e){if(!n||!n.modelPath)throw new Error("u2net_custom requires modelPath in config");const e=`u2net_custom_${n.modelPath}`,t=performance.now();if(!s.bypassSessionCache&&Y.has(e)){const n=Y.get(e);if(te(s,n.getOptions())){oe(e),ne.hits++;const r=performance.now()-t,s=performance.now()-o;return l((r.toFixed(2),s.toFixed(2))),n}{a(),await n.dispose(),Y.delete(e);const t=Z.indexOf(e);t>-1&&Z.splice(t,1),ne.evictions++}}else s.bypassSessionCache&&a();l((performance.now()-t).toFixed(2));const r=performance.now(),i=new q(n,s);l((performance.now()-r).toFixed(2));const c=performance.now();Y.set(e,i),oe(e),ne.misses++,ne.totalSessions++;l((performance.now()-c).toFixed(2)),se().catch(console.warn);return l((performance.now()-o).toFixed(2)),i}const c=performance.now(),g=J.get(e);if(l((performance.now()-c).toFixed(2)),!g){const n=Array.from(J.keys()).join(", ");throw new Error(`No session class found for model '${e}'. Available models: ${n}`)}const d=performance.now();if(!s.bypassSessionCache&&Y.has(e)){const n=Y.get(e);if(te(s,n.getOptions())){oe(e),ne.hits++;const t=performance.now()-d,r=performance.now()-o;return l((t.toFixed(2),r.toFixed(2))),n}{a(),await n.dispose(),Y.delete(e);const t=Z.indexOf(e);t>-1&&Z.splice(t,1),ne.evictions++}}else s.bypassSessionCache&&a();l((performance.now()-d).toFixed(2));const u=performance.now(),m=new g(s);l((performance.now()-u).toFixed(2));const p=performance.now();Y.set(e,m),oe(e),ne.misses++,ne.totalSessions++;l((performance.now()-p).toFixed(2)),se().catch(console.warn);return l((performance.now()-o).toFixed(2)),m}const ae=K,ce="1.0.2";e.IsNetGeneralUseSession=X,e.RembgConfig=s,e.U2NetClothSegSession=H,e.clearModelCache=async function(){await $.clearCache()},e.clearModelCacheForModel=async function(e){await $.clearModelCache(e)},e.clearSessionCache=function(){Y.clear(),Z.length=0,ne.hits=0,ne.misses=0,ne.evictions=0,ne.totalSessions=0},e.configureCache=function(e){void 0!==e.maxSessions&&(ee.maxSessions=Math.max(1,e.maxSessions)),void 0!==e.maxMemoryMB&&(ee.maxMemoryMB=Math.max(1e3,e.maxMemoryMB))},e.disposeAllSessions=async function(){const e=Array.from(Y.values()).map(e=>e.dispose());await Promise.all(e),Y.clear(),Z.length=0},e.enableGeneralLogging=function(e){i.enableGeneralLogging(e)},e.enableONNXProfiling=function(e){i.enableONNXProfiling(e)},e.enablePerformanceLogging=function(e){i.enablePerformanceLogging(e)},e.getAllModelHashes=function(){return{...C}},e.getAvailableModels=function(){const e=Array.from(J.keys());return e.push("u2net_custom"),e},e.getCacheStats=function(){return{...ne,currentSessions:Y.size,maxSessions:ee.maxSessions,hitRate:ne.hits/(ne.hits+ne.misses)||0}},e.getExecutionProviders=k,e.getModelHash=function(e){return C[e]??null},e.getWebGPUContextOptions=function(e){const n={};return e.webgpuPowerPreference&&(n.powerPreference=e.webgpuPowerPreference),n},e.getWebGPUDevice=async function(e){const n=performance.now();if(a(),!L()){return l((performance.now()-n).toFixed(2)),null}try{const t=performance.now(),o=await(navigator.gpu?.requestAdapter(e));if(l((performance.now()-t).toFixed(2)),!o){return l((performance.now()-n).toFixed(2)),null}const r=performance.now(),s=await o.requestDevice();l((performance.now()-r).toFixed(2));return l((performance.now()-n).toFixed(2)),s}catch(e){return c((performance.now()-n).toFixed(2)),null}},e.getWebGPUInfo=T,e.getWebNNContextOptions=function(e){const n={};return e.webnnDeviceType&&(n.deviceType=e.webnnDeviceType),e.webnnPowerPreference&&(n.powerPreference=e.webnnPowerPreference),n},e.getWebNNInfo=B,e.imageUtils=M,e.isGeneralLoggingEnabled=function(){return i.isGeneralLoggingEnabled()},e.isONNXProfilingEnabled=function(){return i.isONNXProfilingEnabled()},e.isPerformanceLoggingEnabled=function(){return i.isPerformanceLoggingEnabled()},e.isWebGPUAvailable=L,e.isWebNNAvailable=z,e.isWebNNDeviceSupported=O,e.logWebGPUInfo=async function(){const e=await T();e.available?(a(),e.adapterInfo&&a((e.adapterInfo.vendor,e.adapterInfo.architecture))):a()},e.logWebNNInfo=async function(){const e=await B();e.available?a(e.supportedDevices.join(", ")):a()},e.newSession=ie,e.rawSessions=ae,e.rembgConfig=i,e.remove=async function(e,n={}){const t=performance.now();a();const o=(e,t,o)=>{n.onProgress&&n.onProgress({step:e,progress:t,message:o})};try{o("downloading",0,"Initializing...");const r=performance.now();let s;if(e instanceof HTMLCanvasElement)s=e,o("downloading",20,"Input ready"),a();else if(e instanceof HTMLImageElement){const n=performance.now();s=m(e);l((performance.now()-n).toFixed(2)),o("downloading",20,"Input ready")}else if(e instanceof File||e instanceof Blob){o("downloading",10,"Loading image...");const n=performance.now(),t=await p(e);l((performance.now()-n).toFixed(2));const r=performance.now();s=m(t);l((performance.now()-r).toFixed(2)),o("downloading",20,"Input ready")}else{if(!(e instanceof ArrayBuffer))throw new Error("Unsupported input type. Supported types: File, Blob, ArrayBuffer, HTMLImageElement, HTMLCanvasElement");{o("downloading",10,"Loading image...");const n=performance.now(),t=await f(e);l((performance.now()-n).toFixed(2));const r=performance.now();s=m(t);l((performance.now()-r).toFixed(2)),o("downloading",20,"Input ready")}}l(((performance.now()-r).toFixed(2),s.width,s.height));const i=performance.now();o("downloading",30,"Preparing model...");const c=n.session||await ie("u2net");l((performance.now()-i).toFixed(2));const g=performance.now();o("processing",40,"Running AI model...");const d=await c.predict(s);if(l((performance.now()-g).toFixed(2)),0===d.length)throw new Error("No masks generated from model");o("processing",70,"Processing mask...");let u=d[0];if(n.postProcessMask){const e=performance.now();o("postprocessing",80,"Applying post-processing..."),u=E(u);l((performance.now()-e).toFixed(2))}if(n.onlyMask){const e=performance.now();o("postprocessing",90,"Creating mask output...");const n=F(u);l((performance.now()-e).toFixed(2));const r=performance.now(),s=await h(n,"image/png");l((performance.now()-r).toFixed(2)),o("complete",100,"Complete");return l((performance.now()-t).toFixed(2)),s}const w=performance.now();o("postprocessing",85,"Creating cutout...");let b=v(s,u);if(l((performance.now()-w).toFixed(2)),n.bgcolor){const e=performance.now();o("postprocessing",90,"Applying background color..."),b=N(b,n.bgcolor);l((performance.now()-e).toFixed(2))}const P=performance.now();o("postprocessing",95,"Finalizing output...");const y=await h(b,"image/png");l((performance.now()-P).toFixed(2)),o("complete",100,"Complete");return l((performance.now()-t).toFixed(2)),y}catch(e){performance.now();throw n.onProgress&&n.onProgress({step:"complete",progress:0,message:`Error: ${e instanceof Error?e.message:"Unknown error"}`}),e}},e.removeToCanvas=async function(e,n={}){const t=performance.now();a();const o=(e,t,o)=>{n.onProgress&&n.onProgress({step:e,progress:t,message:o})};try{o("downloading",0,"Initializing...");const r=performance.now();let s;if(e instanceof HTMLCanvasElement)s=e,o("downloading",20,"Input ready"),a();else if(e instanceof HTMLImageElement){const n=performance.now();s=m(e);l((performance.now()-n).toFixed(2)),o("downloading",20,"Input ready")}else if(e instanceof File||e instanceof Blob){o("downloading",10,"Loading image...");const n=performance.now(),t=await p(e);l((performance.now()-n).toFixed(2));const r=performance.now();s=m(t);l((performance.now()-r).toFixed(2)),o("downloading",20,"Input ready")}else{if(!(e instanceof ArrayBuffer))throw new Error("Unsupported input type. Supported types: File, Blob, ArrayBuffer, HTMLImageElement, HTMLCanvasElement");{o("downloading",10,"Loading image...");const n=performance.now(),t=await f(e);l((performance.now()-n).toFixed(2));const r=performance.now();s=m(t);l((performance.now()-r).toFixed(2)),o("downloading",20,"Input ready")}}l(((performance.now()-r).toFixed(2),s.width,s.height));const i=performance.now();o("downloading",30,"Preparing model...");const c=n.session||await ie("u2net");l((performance.now()-i).toFixed(2));const g=performance.now();o("processing",40,"Running AI model...");const d=await c.predict(s);if(l((performance.now()-g).toFixed(2)),0===d.length)throw new Error("No masks generated from model");o("processing",70,"Processing mask...");let u=d[0];if(n.postProcessMask){const e=performance.now();o("postprocessing",80,"Applying post-processing..."),u=E(u);l((performance.now()-e).toFixed(2))}if(n.onlyMask){const e=performance.now();o("postprocessing",90,"Creating mask output...");const n=F(u);l((performance.now()-e).toFixed(2)),o("complete",100,"Complete");return l((performance.now()-t).toFixed(2)),n}const h=performance.now();o("postprocessing",85,"Creating cutout...");let w=v(s,u);if(l((performance.now()-h).toFixed(2)),n.bgcolor){const e=performance.now();o("postprocessing",90,"Applying background color..."),w=N(w,n.bgcolor);l((performance.now()-e).toFixed(2))}o("complete",100,"Complete");return l((performance.now()-t).toFixed(2)),w}catch(e){performance.now();throw n.onProgress&&n.onProgress({step:"complete",progress:0,message:`Error: ${e instanceof Error?e.message:"Unknown error"}`}),e}},e.setModelHash=function(e,n){C[e]=n},e.validateModel=I,e.validateModelSize=U,e.validateWebGPUConfig=D,e.validateWebNNConfig=W,e.verifyModelIntegrity=S,e.version=ce});
//# sourceMappingURL=index.umd.min.js.map
